# 5.2.1 车道线真值构建流程及结构化表示

车道线真值的构建是将离散的标注点转化为模型可学习的结构化张量的过程。针对 OpenLane 等数据集，本研究设计了标准化的真值构建流程，确保标签在几何上的连续性与分布的一致性。

## 1. 真值构建流程

车道线真值构建主要包含原始数据解析、视口过滤与清洗、坐标归一化、固定 Y 轴重采样、及结构化张量生成五个步骤。

### 1.1 流程详述

1.  **原始数据解析 (Raw Parsing)**
    读取数据集提供的 JSON 标注文件，获取每条车道线的原始像素点集 $P_{raw} = \{(x_i, y_i)\}_{i=1}^N$。

2.  **视口过滤与清洗 (Viewport Filtering)**
    剔除图像边界外的异常点，保留满足 $0 \le x < W$ 且 $0 \le y < H$ 的有效点，其中 $W$ 和 $H$ 分别为图像的宽度和高度。

3.  **坐标归一化 (Normalization)**
    为了消除图像分辨率差异，增强模型的泛化能力，将像素坐标映射至 $[0, 1]$ 空间：
    $$ x' = \frac{x}{W}, \quad y' = \frac{y}{H} $$

4.  **固定 Y 轴重采样 (Fixed-Y Sampling)**
    采用预定义的 $N_{sample}$ 个 Y 轴锚点 $Y_{ref} = \{y_j | y_j \in [0, 1], j=1, \dots, N_{sample}\}$（例如从图像底部到顶部均匀分布），计算对应的 X 坐标。

5.  **结构化张量生成 (Tensor Generation)**
    最终输出张量 $T \in \mathbb{R}^{N \times (C + 4 + N_{sample})}$，包含分类置信度、几何参数及采样点偏移量。

## 2. 结构化表示

为了适应基于 Anchor 的检测框架，车道线被建模为一组参数集合 $\mathcal{L}$，其数学形式定义如下：

$$ \mathcal{L} = \{y_{start}, x_{start}, \theta, L, \mathbf{x}_{offsets}, c\} $$

各参数含义如下：

*   **起始点坐标 $(y_{start}, x_{start})$**：
    车道线在图像坐标系中的起始位置（通常位于图像底部或车道线首次出现的位置），均已归一化至 $[0, 1]$。

*   **切线角度 $\theta$**：
    车道线在起始位置处的切线与垂直方向（或 Y 轴负方向）的夹角，用于约束车道线的初始延伸方向。其计算公式为：
    $$ \theta = 0.5 + \frac{1}{\pi} \arctan\left(-k\right) $$
    其中 $k = \frac{dx}{dy}$ 为起始点附近通过最小二乘法拟合得到的斜率。

*   **归一化长度 $L$**：
    车道线在 Y 轴方向上的投影长度，归一化到采样点总数。
    $$ L = \frac{N_{valid}}{N_{points}} $$
    其中 $N_{valid}$ 为有效采样点数量，$N_{points}$ 为总采样点数。

*   **水平偏移量集合 $\mathbf{x}_{offsets}$**：
    在固定 Y 坐标下的水平偏移量集合，描述车道线的具体形态。$\mathbf{x}_{offsets} \in \mathbb{R}^{N_{sample}}$，其中第 $j$ 个元素表示车道线在 $y_j$ 处的横坐标 $x_j$ 相对于 Anchor 参考线的偏移量。

*   **分类置信度 $c$**：
    表示该位置存在车道线的概率或类别标签。
    $$ c = \mathbb{I}(N_{valid} \ge 2) $$
    若车道线有效点数大于等于2，则 $c=1$（或对应类别索引），否则 $c=0$（背景）。
